name: Deploy to Production

on:
  workflow_run:
    workflows: ["Unit and Integration Tests", "E2E Tests"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Wait for all required workflows to complete successfully
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const sha = context.payload.workflow_run.head_sha;
          
          console.log(`Checking workflows for commit: ${sha}`);
          
          // Wait up to 10 minutes for all workflows to complete
          const maxWaitTime = 10 * 60 * 1000; // 10 minutes in milliseconds
          const pollInterval = 30 * 1000; // 30 seconds
          const startTime = Date.now();
          
          const requiredWorkflows = ['Unit and Integration Tests', 'E2E Tests'];
          
          while (Date.now() - startTime < maxWaitTime) {
            // Get all workflow runs for this commit
            const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              head_sha: sha,
              per_page: 100
            });
            
            console.log(`Found ${workflowRuns.workflow_runs.length} workflow runs for commit ${sha}`);
            
            // Filter for our required workflows
            const relevantRuns = workflowRuns.workflow_runs
              .filter(run => requiredWorkflows.includes(run.name))
              .filter(run => run.head_sha === sha);
            
            console.log(`Found ${relevantRuns.length} relevant workflow runs`);
            
            // Check status of each required workflow
            const workflowStatus = {};
            for (const workflow of requiredWorkflows) {
              const runs = relevantRuns.filter(run => run.name === workflow);
              if (runs.length === 0) {
                workflowStatus[workflow] = 'not_found';
              } else {
                // Get the most recent run for this workflow
                const latestRun = runs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                workflowStatus[workflow] = {
                  status: latestRun.status,
                  conclusion: latestRun.conclusion,
                  id: latestRun.id
                };
              }
            }
            
            console.log('Workflow status:', JSON.stringify(workflowStatus, null, 2));
            
            // Check if all workflows are completed
            const allCompleted = requiredWorkflows.every(workflow => {
              const status = workflowStatus[workflow];
              return status !== 'not_found' && status.status === 'completed';
            });
            
            if (allCompleted) {
              // Check if all workflows succeeded
              const allSuccessful = requiredWorkflows.every(workflow => {
                const status = workflowStatus[workflow];
                return status.conclusion === 'success';
              });
              
              if (allSuccessful) {
                console.log('✅ All required workflows completed successfully!');
                return;
              } else {
                // Find which workflows failed
                const failedWorkflows = requiredWorkflows.filter(workflow => {
                  const status = workflowStatus[workflow];
                  return status.conclusion !== 'success';
                });
                
                core.setFailed(`❌ The following workflows did not succeed: ${failedWorkflows.join(', ')}`);
                return;
              }
            }
            
            console.log('⏳ Waiting for all workflows to complete...');
            await new Promise(resolve => setTimeout(resolve, pollInterval));
          }
          
          // Timeout reached
          core.setFailed('❌ Timeout: Not all required workflows completed within the time limit');

    - name: Deploy to Render
      run: |
        echo "Deploying to production..."
        curl -X POST "${{ secrets.DEPLOYMENT_URL }}"
        echo "Deployment webhook triggered successfully"

    - name: Generate deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "✅ Application deployed to production successfully" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA:** ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
